# Shri Ram Physio - Backend API

## Overview

REST API backend for the Shri Ram Physio invoice management system. Built with **Express**, **Prisma ORM**, and **Azure SQL Database**.

## Architecture

**MVC Pattern with Prisma ORM**

```
Express Routes → Controllers → Prisma Client → Azure SQL
```

- **Routes** (`src/routes/`) - HTTP endpoint definitions
- **Controllers** (`src/controllers/`) - Business logic
- **Models** - Auto-generated by Prisma from `schema.prisma`
- **Views** - JSON responses

## Tech Stack

- **Node.js 18+** - JavaScript runtime
- **Express 4.18** - Web framework
- **Prisma 7.1.0** - Modern ORM
- **Azure SQL** - Cloud database
- **TypeScript** - Type safety
- **GitHub Actions** - CI/CD automation

## Quick Start

### Option A: Docker Setup (Recommended for Local Development)

**Prerequisites**: Docker Desktop installed and running

```powershell
# 1. Start SQL Server container
.\start-db.ps1
# Or: docker-compose up -d sqlserver

# 2. Install dependencies
npm install

# 3. Initialize database
npm run prisma:push

# 4. Start backend
npm run dev
```

Backend runs on http://localhost:3000 with local SQL Server on `localhost:1433`

See **[DOCKER_SETUP.md](./DOCKER_SETUP.md)** for detailed Docker documentation.

### Option B: Azure SQL Setup (Production)

**Prerequisites**: Azure SQL Database created

```powershell
# 1. Install dependencies
npm install

# 2. Configure .env with Azure SQL connection
# DATABASE_URL="sqlserver://your-server.database.windows.net:1433;database=your-db;user=your-user;password=your-password;encrypt=true;trustServerCertificate=false"

# 3. Generate Prisma Client
npm run prisma:generate

# 4. Initialize database
npm run prisma:push

# 5. Start backend
npm run dev
```

### 3. Generate Prisma Client (if not already done)

```powershell
npm run prisma:generate
```

### 4. Run Migrations

```powershell
npm run prisma:migrate
```

### 5. Start Server

```powershell
npm run dev
```

Server runs on http://localhost:3000

## API Endpoints

### Patients

- `GET /api/patients` - Get all patients
- `GET /api/patients/search?q=term` - Search patients
- `GET /api/patients/:id` - Get patient by ID
- `POST /api/patients` - Create patient
- `PUT /api/patients/:id` - Update patient
- `DELETE /api/patients/:id` - Delete patient

### Invoices

- `GET /api/invoices` - Get all invoices
- `GET /api/invoices/:id` - Get invoice by ID
- `GET /api/invoices/patient/:patientId` - Get invoices by patient
- `POST /api/invoices` - Create invoice with treatments
- `PUT /api/invoices/:id` - Update invoice
- `DELETE /api/invoices/:id` - Delete invoice

### Sync

- `POST /api/sync` - Bidirectional sync endpoint

See **[API_DOCUMENTATION.md](./API_DOCUMENTATION.md)** for complete API reference.

## Project Structure

```
Backend/
├── prisma/
│   ├── schema.prisma           # Database schema
│   └── migrations/             # Migration history
├── src/
│   ├── controllers/            # Business logic
│   │   ├── syncController.ts   # Sync operations
│   │   ├── patient.ts          # Patient CRUD
│   │   └── invoice.ts          # Invoice CRUD
│   ├── routes/                 # HTTP endpoints
│   │   ├── syncPrisma.ts       # Sync routes
│   │   ├── patient.ts          # Patient routes
│   │   └── invoice.ts          # Invoice routes
│   ├── lib/
│   │   └── prisma.ts           # Prisma Client singleton
│   └── server.ts               # Express app setup
├── .env                        # Environment variables
├── package.json                # Dependencies & scripts
├── tsconfig.json               # TypeScript config
└── API_DOCUMENTATION.md        # Complete API docs
```

## Development

### Available Scripts

```powershell
# Development
npm run dev              # Start with nodemon (auto-reload)
npm run build            # Build TypeScript + generate Prisma Client
npm start                # Run production build

# Prisma Commands
npm run prisma:generate  # Generate Prisma Client
npm run prisma:migrate   # Create migration (dev)
npm run prisma:deploy    # Deploy migrations (production)
npm run prisma:studio    # Open Prisma Studio GUI

# Testing
npm test                 # Run tests (if configured)
```

### Adding New Endpoints

1. **Create Controller** (`src/controllers/myController.ts`):

```typescript
import { Request, Response } from 'express';
import prisma from '../lib/prisma';

export const myFunction = async (req: Request, res: Response) => {
  try {
    const data = await prisma.myModel.findMany();
    res.json({ success: true, data });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
```

2. **Create Route** (`src/routes/myRoute.ts`):

```typescript
import { Router } from 'express';
import { myFunction } from '../controllers/myController';

const router = Router();

router.get('/', myFunction);

export default router;
```

3. **Register in Server** (`src/server.ts`):

```typescript
import myRoute from './routes/myRoute';
app.use('/api/my-endpoint', myRoute);
```

## Database Schema

### Models

**Patient**
- `id` (Int) - Primary key
- `name`, `age`, `gender`, `phone`, `uhid` - Patient info
- `createdAt`, `updatedAt` - Auto-managed timestamps
- Relations: `invoices[]`

**Invoice**
- `id` (Int) - Primary key
- `invoiceNumber`, `patientId`, `date`, `diagnosis`, `total`
- `createdAt`, `updatedAt`
- Relations: `patient`, `treatments[]`

**Treatment**
- `id` (Int) - Primary key
- `invoiceId`, `name`, `sessions`, `startDate`, `endDate`, `amount`
- `createdAt`, `updatedAt`
- Relations: `invoice`

### Schema Changes

1. Edit `prisma/schema.prisma`
2. Create migration:
   ```powershell
   npm run prisma:migrate
   ```
3. Prisma Client auto-updates with new types!

## Deployment

### GitHub Actions (Automated)

This project uses **GitHub Actions** for CI/CD:

- **CI Workflow** (`.github/workflows/backend-ci.yml`)
  - Runs on pull requests
  - Type checks, builds, validates schema
  - Ensures code quality before merge

- **CD Workflow** (`.github/workflows/backend-deploy.yml`)
  - Runs on push to `main` branch
  - Builds, deploys to Azure App Service
  - Runs database migrations automatically

### Setup GitHub Actions

1. **Add GitHub Secrets** (Repository → Settings → Secrets):
   - `AZURE_WEBAPP_PUBLISH_PROFILE` - Download from Azure Portal
   - `DATABASE_URL` - Your production database connection string

2. **Push to main**:
   ```powershell
   git add .
   git commit -m "Deploy to Azure"
   git push origin main
   ```

3. **Monitor deployment**:
   - Go to GitHub → Actions tab
   - Watch workflow execute
   - Verify in Azure Portal

See **[../.github/ACTIONS_SETUP.md](../.github/ACTIONS_SETUP.md)** for detailed setup instructions.

### Manual Deployment (Alternative)

If you prefer manual deployment:

1. **Build locally**:
   ```powershell
   npm run build
   ```

2. **Deploy to Azure**:
   - Option A: ZIP Deploy via Azure Portal
   - Option B: Local Git deployment
   - Option C: GitHub integration (manual trigger)

3. **Run migrations**:
   ```powershell
   npm run prisma:deploy
   ```

## Environment Variables

### Development (.env)

```env
DATABASE_URL="sqlserver://localhost:1433;database=ShriRamPhysio;user=sa;password=dev;encrypt=true;trustServerCertificate=true"
PORT=3000
NODE_ENV=development
ALLOWED_ORIGINS=*
```

### Production (Azure App Service)

Set in Azure Portal → App Service → Configuration:

```env
DATABASE_URL=sqlserver://your-server.database.windows.net:1433;database=your-db;user=your-user;password=your-password;encrypt=true
PORT=8080
NODE_ENV=production
ALLOWED_ORIGINS=https://your-frontend-domain.com
```

## Prisma Commands

```powershell
# Generate Prisma Client (after schema changes)
npx prisma generate

# Create migration (development)
npx prisma migrate dev --name description

# Deploy migrations (production)
npx prisma migrate deploy

# Reset database (⚠️ deletes all data)
npx prisma migrate reset

# Open Prisma Studio (GUI)
npx prisma studio

# Validate schema
npx prisma validate

# Format schema file
npx prisma format
```

## Troubleshooting

### "Cannot find module '@prisma/client'"

```powershell
npm run prisma:generate
```

### Migration errors

```powershell
# Check migration status
npx prisma migrate status

# Resolve migration conflicts
npx prisma migrate resolve --applied <migration_name>

# Reset database (dev only)
npx prisma migrate reset
```

### Build errors

```powershell
# Clean and rebuild
Remove-Item -Recurse -Force node_modules, dist
npm install
npm run build
```

### Azure deployment fails

1. Check Application settings in Azure Portal
2. Verify `DATABASE_URL` is correct
3. Check deployment logs in Azure Portal
4. Test health endpoint: `https://your-app.azurewebsites.net/health`

## Testing

### Test Endpoints Locally

```powershell
# Health check
curl http://localhost:3000/health

# Get all patients
curl http://localhost:3000/api/patients

# Create patient
curl -X POST http://localhost:3000/api/patients -H "Content-Type: application/json" -d '{"name":"Test","age":30,"gender":"Male","phone":"1234567890","uhid":"TEST001"}'
```

### Use Prisma Studio

```powershell
npm run prisma:studio
```

Opens at http://localhost:5555 - view/edit database records with GUI.

## Documentation

- **[API_DOCUMENTATION.md](./API_DOCUMENTATION.md)** - Complete REST API reference
- **[REFACTORING_SUMMARY.md](./REFACTORING_SUMMARY.md)** - Backend refactoring details
- **[CLEANUP_SUMMARY.md](./CLEANUP_SUMMARY.md)** - Deprecated code cleanup report
- **[../PRISMA_GUIDE.md](../PRISMA_GUIDE.md)** - Comprehensive Prisma integration guide
- **[../SETUP.md](../SETUP.md)** - Azure deployment guide

## Contributing

1. Create feature branch
2. Make changes
3. Test locally
4. Create pull request
5. CI workflow runs automatically
6. After merge, CD workflow deploys to Azure

## License

Private project - All rights reserved

---

**Status**: ✅ Production-ready with automated CI/CD

**Last Updated**: December 2025